# 测试策略

## 测试金字塔

```
    E2E Tests
    /        \
  Integration Tests
  /            \
Frontend Unit  Backend Unit
```

## 测试组织

### 前端测试

```
apps/web/tests/
├── unit/               # 单元测试
│   ├── components/     # 组件测试
│   ├── hooks/          # Hook测试
│   ├── services/       # 服务测试
│   └── utils/          # 工具函数测试
├── integration/        # 集成测试
│   ├── pages/          # 页面集成测试
│   └── flows/          # 用户流程测试
└── e2e/               # 端到端测试
    ├── auth/          # 认证流程
    ├── booking/       # 预订流程
    └── admin/         # 管理流程
```

### 后端测试

```
apps/api/src/test/
├── unit/               # 单元测试
│   ├── controller/     # 控制器测试
│   ├── service/        # 服务层测试
│   ├── repository/     # 数据访问测试
│   └── util/           # 工具类测试
├── integration/        # 集成测试
│   ├── api/           # API集成测试
│   ├── database/      # 数据库集成测试
│   └── external/      # 外部服务集成测试
└── e2e/               # 端到端测试
    ├── booking/       # 预订场景
    ├── payment/       # 支付场景
    └── admin/         # 管理场景
```

### 端到端测试

```
tests/e2e/
├── auth.spec.ts         # 认证测试
├── booking.spec.ts      # 预订测试
├── review.spec.ts       # 评价测试
└── admin.spec.ts        # 管理测试
```

## 测试示例

### 前端组件测试

```typescript
// apps/web/tests/unit/components/RoomCard.spec.ts
import { mount } from '@vue/test-utils';
import { describe, it, expect, vi } from 'vitest';
import RoomCard from '@/components/business/RoomCard.vue';
import type { Room } from '@/types/room';

describe('RoomCard', () => {
  const mockRoom: Room = {
    id: 1,
    hotelId: 1,
    roomTypeId: 1,
    roomNumber: '101',
    floor: 1,
    area: 25,
    status: 'AVAILABLE',
    price: 299,
    images: ['room1.jpg'],
    facilities: ['WiFi', '空调', '电视'],
    createdAt: '2023-01-01T00:00:00Z',
    updatedAt: '2023-01-01T00:00:00Z',
  };

  it('renders room information correctly', () => {
    const wrapper = mount(RoomCard, {
      props: { room: mockRoom },
    });

    expect(wrapper.find('.room-card__title').text()).toBe('101 - 标准间');
    expect(wrapper.find('.room-card__info').text()).toContain('楼层: 1');
    expect(wrapper.find('.room-card__info').text()).toContain('面积: 25㎡');
    expect(wrapper.find('.price-value').text()).toBe('299');
  });

  it('shows correct status badge', () => {
    const wrapper = mount(RoomCard, {
      props: { room: mockRoom },
    });

    const statusBadge = wrapper.find('.room-card__status');
    expect(statusBadge.text()).toBe('可预订');
    expect(statusBadge.classes()).toContain('room-card__status--available');
  });

  it('disables book button when room is not available', () => {
    const unavailableRoom = { ...mockRoom, status: 'OCCUPIED' as const };
    const wrapper = mount(RoomCard, {
      props: { room: unavailableRoom },
    });

    const bookButton = wrapper.find('button');
    expect(bookButton.attributes('disabled')).toBeDefined();
    expect(bookButton.text()).toBe('不可预订');
  });

  it('emits book event when book button is clicked', async () => {
    const wrapper = mount(RoomCard, {
      props: { room: mockRoom },
    });

    await wrapper.find('button').trigger('click');

    expect(wrapper.emitted('book')).toBeTruthy();
    expect(wrapper.emitted('book')[0]).toEqual([mockRoom]);
  });
});
```

### 后端API测试

```java
// apps/api/src/test/java/com/hotel/controller/RoomControllerTest.java
@ExtendWith(MockitoExtension.class)
class RoomControllerTest {

    @Mock
    private RoomService roomService;

    @InjectMocks
    private RoomController roomController;

    @Test
    @DisplayName("应该成功搜索可用房间")
    void shouldSearchAvailableRooms() {
        // Given
        RoomSearchRequest request = new RoomSearchRequest();
        request.setHotelId(1L);
        request.setCheckInDate(LocalDate.now());
        request.setCheckOutDate(LocalDate.now().plusDays(1));
        request.setGuestCount(2);

        RoomSearchResponse response = new RoomSearchResponse();
        response.setRooms(Arrays.asList(new Room()));
        response.setTotal(1);

        when(roomService.searchAvailableRooms(request)).thenReturn(response);

        // When
        ResponseEntity<ApiResponse<RoomSearchResponse>> result =
                roomController.searchRooms(request);

        // Then
        assertThat(result.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(result.getBody().isSuccess()).isTrue();
        assertThat(result.getBody().getData()).isEqualTo(response);

        verify(roomService).searchAvailableRooms(request);
    }

    @Test
    @DisplayName("应该返回房间详情")
    void shouldGetRoomById() {
        // Given
        Long roomId = 1L;
        Room room = new Room();
        room.setId(roomId);
        room.setRoomNumber("101");

        when(roomService.getRoomById(roomId)).thenReturn(room);

        // When
        ResponseEntity<ApiResponse<Room>> result =
                roomController.getRoomById(roomId);

        // Then
        assertThat(result.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(result.getBody().isSuccess()).isTrue();
        assertThat(result.getBody().getData().getId()).isEqualTo(roomId);
        assertThat(result.getBody().getData().getRoomNumber()).isEqualTo("101");

        verify(roomService).getRoomById(roomId);
    }

    @Test
    @DisplayName("应该拒绝无效的房间ID")
    void shouldRejectInvalidRoomId() {
        // Given
        Long invalidRoomId = -1L;

        // When
        ResponseEntity<ApiResponse<Room>> result =
                roomController.getRoomById(invalidRoomId);

        // Then
        assertThat(result.getStatusCode()).isEqualTo(HttpStatus.BAD_REQUEST);
    }
}
```

### 端到端测试

```typescript
// tests/e2e/booking.spec.ts
import { test, expect } from '@playwright/test';

test.describe('房间预订流程', () => {
  test.beforeEach(async ({ page }) => {
    // 登录
    await page.goto('/auth/login');
    await page.fill('[data-testid="email"]', 'test@example.com');
    await page.fill('[data-testid="password"]', 'password123');
    await page.click('[data-testid="login-button"]');
    await expect(page).toHaveURL('/home');
  });

  test('用户应该能够搜索并预订房间', async ({ page }) => {
    // 搜索房间
    await page.click('[data-testid="search-button"]');
    await page.fill('[data-testid="check-in-date"]', '2024-01-01');
    await page.fill('[data-testid="check-out-date"]', '2024-01-02');
    await page.fill('[data-testid="guest-count"]', '2');
    await page.click('[data-testid="search-submit"]');

    // 验证搜索结果
    await expect(page.locator('[data-testid="room-card"]')).toHaveCount.greaterThan(0);

    // 选择房间
    await page.click('[data-testid="room-card"]:first-child [data-testid="book-button"]');

    // 填写预订信息
    await page.fill('[data-testid="guest-name"]', '张三');
    await page.fill('[data-testid="guest-phone"]', '13800138000');
    await page.fill('[data-testid="special-requests"]', '需要无烟房');

    // 确认预订
    await page.click('[data-testid="confirm-booking"]');

    // 验证预订成功
    await expect(page.locator('[data-testid="success-message"]')).toBeVisible();
    await expect(page.locator('[data-testid="order-number"]')).toBeVisible();
  });

  test('应该显示正确的预订详情', async ({ page }) => {
    // 搜索并预订房间（同上）
    // ...

    // 查看订单详情
    await page.click('[data-testid="view-order-details"]');

    // 验证订单信息
    await expect(page.locator('[data-testid="order-hotel-name"]')).toBeVisible();
    await expect(page.locator('[data-testid="order-room-number"]')).toBeVisible();
    await expect(page.locator('[data-testid="order-check-in-date"]')).toBeVisible();
    await expect(page.locator('[data-testid="order-total-price"]')).toBeVisible();
  });
});
```
