# Story 4.4: 评价评分统计

## Status

Done

## Story

**作为** 酒店管理员，
**我想要** 查看评价的统计和分析，
**以便** 了解服务质量和改进方向。

## Acceptance Criteria

1. 综合评分：总体评分和各维度评分展示
2. 评分趋势：评分随时间的变化趋势
3. 评价词云：从评价文本提取关键词
4. 对比分析：与同类酒店评分对比
5. 改进建议：基于评价数据的改进建议

## Tasks / Subtasks

- [x] 后端评价统计分析API (AC: 1, 2, 4)
  - [x] 扩展ReviewAnalyticsService添加高级统计功能
  - [x] 实现综合评分计算算法（总体和各维度）
  - [x] 实现评分时间序列分析（月度、季度趋势）
  - [x] 实现酒店对比分析功能
  - [x] 创建ReviewStatisticsController控制器
  - [x] 添加统计相关的DTO类（ReviewStatisticsDTO、RatingTrendDTO等）
  - [x] 实现统计数据缓存策略（按天/周/月缓存）

- [x] 后端评价文本分析功能 (AC: 3, 5)
  - [x] 集成文本分析服务（词频统计、关键词提取）
  - [x] 实现评价词云生成API
  - [x] 实现基于评价内容的改进建议算法
  - [x] 创建评价情感分析功能（可选增强）
  - [x] 实现评价关键词趋势分析

- [x] 前端评价统计主页面 (AC: 1, 2, 4)
  - [x] 创建ReviewStatistics主统计页面组件
  - [x] 实现综合评分展示组件（雷达图、仪表盘）
  - [x] 创建评分趋势图表组件（折线图、柱状图）
  - [x] 实现酒店对比分析组件
  - [x] 添加时间筛选器（按日/周/月/季度）
  - [x] 扩展reviewService添加统计API调用

- [x] 前端评价词云和建议组件 (AC: 3, 5)
  - [x] 创建ReviewWordCloud词云组件
  - [x] 实现关键词列表和趋势组件
  - [x] 创建改进建议展示组件
  - [x] 实现评价详情的快速跳转功能
  - [x] 添加统计数据的导出功能

- [x] 性能优化和缓存 (AC: 所有)
  - [x] 实现Redis缓存策略，缓存常用统计数据
  - [x] 优化大数据量统计查询性能
  - [x] 实现异步数据更新机制
  - [x] 添加图表懒加载功能

## Dev Notes

### Previous Story Insights
从故事4.3中学习到的关键信息：
- 已实现ReviewAnalyticsService基础框架，包含Redis缓存支持
- 评价实体包含多维度评分：overallRating、cleanlinessRating、serviceRating、facilitiesRating、locationRating
- 管理员权限验证和XSS防护机制已建立
- 前端已集成ECharts图表库，可用于数据可视化

### Data Models
**现有Review模型** [Source: 从故事4.3提取]：
```java
// Review实体相关字段
- id: Long
- userId: Long
- hotelId: Long
- roomId: Long
- orderId: Long
- overallRating: Integer (1-5)
- cleanlinessRating: Integer (1-5)
- serviceRating: Integer (1-5)
- facilitiesRating: Integer (1-5)
- locationRating: Integer (1-5)
- comment: String
- status: ReviewStatus
- createdAt: LocalDateTime
```

**需要新增的统计相关DTO**：
```java
// 综合评分统计
ReviewStatisticsDTO {
    hotelId: Long
    totalReviews: Integer
    overallRating: Double
    dimensionRatings: Map<String, Double>
    ratingDistribution: Map<Integer, Integer>
    trendData: List<RatingTrendDTO>
}

// 评分趋势数据
RatingTrendDTO {
    period: String  // 2024-01, 2024-W01, etc.
    overallRating: Double
    dimensionRatings: Map<String, Double>
    reviewCount: Integer
}

// 词云数据
WordCloudDTO {
    word: String
    count: Integer
    weight: Double
}

// 对比分析数据
HotelComparisonDTO {
    hotelId: Long
    hotelName: String
    overallRating: Double
    dimensionRatings: Map<String, Double>
    reviewCount: Integer
    ranking: Integer
}
```

### API Specifications
**统计分析API** [Source: architecture/rest-api-spec.md]：
```java
// 综合评分统计
GET /v1/admin/reviews/statistics/overview?hotelId={id}&period={daily|weekly|monthly}
Response: ReviewStatisticsDTO

// 评分趋势数据
GET /v1/admin/reviews/statistics/trends?hotelId={id}&startDate={date}&endDate={date}&groupBy={day|week|month}
Response: List<RatingTrendDTO>

// 评价词云
GET /v1/admin/reviews/statistics/wordcloud?hotelId={id}&limit={count}
Response: List<WordCloudDTO>

// 酒店对比分析
GET /v1/admin/reviews/statistics/comparison?hotelId={id}&competitorIds={ids}
Response: List<HotelComparisonDTO>

// 改进建议
GET /v1/admin/reviews/statistics/suggestions?hotelId={id}&category={service|cleanliness|facilities|location}
Response: List<SuggestionDTO>

// 导出统计数据
GET /v1/admin/reviews/statistics/export?hotelId={id}&format={excel|pdf}&period={monthly|quarterly}
Response: File download
```

### Component Specifications
**Frontend Component Structure** [Source: architecture/前端架构.md#组件组织]：
- Main statistics page: `apps/web/src/pages/admin/reviews/ReviewStatistics.vue` (new)
- Overview dashboard: `apps/web/src/components/business/review/StatisticsOverview.vue` (new)
- Rating trends: `apps/web/src/components/business/review/RatingTrendChart.vue` (new)
- Word cloud: `apps/web/src/components/business/review/ReviewWordCloud.vue` (new)
- Hotel comparison: `apps/web/src/components/business/review/HotelComparisonChart.vue` (new)
- Suggestions: `apps/web/src/components/business/review/ImprovementSuggestions.vue` (new)
- Time filter: `apps/web/src/components/business/review/StatisticsTimeFilter.vue` (new)
- Export functionality: `apps/web/src/components/business/review/StatisticsExport.vue` (new)

### File Locations
Based on project structure [Source: architecture/统一项目结构.md]:
**Backend:**
- Controller - Statistics: `apps/api/src/main/java/com/hotel/controller/review/ReviewStatisticsController.java` (new)
- Service - Statistics: `apps/api/src/main/java/com/hotel/service/ReviewStatisticsService.java` (new)
- Service - Text Analysis: `apps/api/src/main/java/com/hotel/service/TextAnalysisService.java` (new)
- DTOs: `apps/api/src/main/java/com/hotel/dto/review/statistics/` (new directory)
- Update existing: `apps/api/src/main/java/com/hotel/service/ReviewAnalyticsService.java`

**Frontend:**
- Statistics page: `apps/web/src/pages/admin/reviews/ReviewStatistics.vue` (new)
- Components: `apps/web/src/components/business/review/statistics/` (new directory)
- Update existing: `apps/web/src/services/reviewService.ts`

### Business Rules
**评分计算规则**：
- 综合评分 = 所有overallRating的平均值，保留1位小数
- 维度评分 = 各维度评分的独立平均值
- 评分趋势使用加权平均，最近的数据权重更高
- 只计算已审核通过（APPROVED）的评价

**词云生成规则**：
- 只分析中文内容，过滤停用词
- 最小词频为3次，避免过多低频词
- 词云大小基于词频和对评价的影响度
- 支持自定义时间段分析

**对比分析规则**：
- 对比同类酒店（相同星级、相同城市区域）
- 排名基于综合评分，考虑评价数量权重
- 显示各维度的优劣势对比
- 提供行业平均值作为参考基准

### Integration Points
- 扩展ReviewAnalyticsService，复用现有的缓存机制
- 利用现有的ECharts库进行图表渲染
- 集成文本分析API（可使用阿里云NLP服务或本地实现）
- 复用权限验证和XSS防护机制
- 利用文件服务实现统计报告导出功能

### Security Considerations
- 管理员权限验证：只有ADMIN角色可以查看统计数据
- 酒店数据隔离：管理员只能查看自己管理酒店的数据
- 敏感数据脱敏：对比分析时隐藏竞品酒店的详细信息
- 访问频率限制：防止大量统计查询影响性能
- 导出权限控制：不同级别管理员有不同的导出权限

### Performance Considerations
- 数据缓存：统计数据按天缓存，实时数据每小时更新
- 分页处理：大量词云数据分页加载
- 异步计算：耗时统计任务异步执行，结果推送
- 数据库优化：为统计查询添加复合索引
- 前端优化：图表懒加载，按需渲染

### UI/UX Considerations
- 响应式设计：支持移动端查看统计数据
- 交互式图表：支持鼠标悬停显示详细信息
- 时间范围选择：快捷选择（最近7天、30天、季度、年度）
- 数据钻取：点击图表可查看详细数据
- 导出功能：支持Excel、PDF格式导出
- 实时更新：统计数据定期自动刷新

## Testing

**Testing Standards** [Source: architecture/测试策略.md]
- Frontend tests: `apps/web/tests/unit/components/business/review/statistics/`
- Backend tests: `apps/api/src/test/unit/service/review/statistics/` (new)
- Integration tests: `apps/api/src/test/integration/api/ReviewStatisticsControllerTest.java` (new)
- E2E tests: `tests/e2e/admin/review-statistics.spec.ts` (new)

**Testing Framework**:
- Frontend: Vitest + Vue Test Utils [Source: architecture/技术栈.md]
- Backend: JUnit 5 + Mockito [Source: architecture/技术栈.md]
- E2E: Playwright [Source: architecture/技术栈.md]

**Key Test Scenarios**:
- Statistics data accuracy across different time periods
- Rating trend calculations with various date ranges
- Word cloud generation with different text inputs
- Hotel comparison functionality with multiple competitors
- Export functionality for different formats
- Performance with large datasets
- Cache invalidation and refresh
- Permission enforcement for different admin roles
- Mobile responsive design for statistics views
- Real-time data updates

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-09 | 1.0 | Initial story creation | Scrum Master Bob |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (model ID: claude-sonnet-4-5-20251101)

### Debug Log References

主要实现参考了故事4.3中的ReviewAnalyticsService基础框架，并在此基础上扩展了高级统计功能。所有组件均已按照现有项目架构实现。

### Completion Notes

1. **后端实现完成度：100%**
   - 扩展了ReviewAnalyticsService，添加了综合评分、趋势分析、词云生成、酒店对比等功能
   - 实现了TextAnalysisService，支持中文分词、情感分析、改进建议生成
   - 创建了完整的DTO体系：ReviewStatisticsDTO、RatingTrendDTO、WordCloudDTO、HotelComparisonDTO、SuggestionDTO
   - 新增ReviewStatisticsController提供完整的REST API接口
   - 实现了基于Spring Cache的Redis缓存策略，优化查询性能

2. **前端实现完成度：100%**
   - 创建了ReviewStatistics主统计页面，包含概览卡片、图表筛选等功能
   - 实现了StatisticsOverview组件，支持雷达图和柱状图切换展示
   - 完成了RatingTrendChart组件，展示多维度评分趋势
   - 实现了ReviewWordCloud组件，支持交互式词云展示
   - 创建了ImprovementSuggestions组件，分类展示改进建议
   - 完成了HotelComparisonChart组件，支持竞品对比分析
   - 扩展了reviewService，添加了所有统计相关的API调用

3. **性能优化完成**
   - 创建了数据库索引优化脚本V1_0_5__Add_review_performance_indexes.sql
   - 添加了复合索引支持高频统计查询
   - 实现了多级缓存策略（统计数据缓存、词云缓存、建议缓存）
   - 前端实现了图表懒加载和分页加载

4. **安全考虑**
   - 所有API接口都有管理员权限验证
   - 实现了酒店数据隔离
   - 添加了访问频率限制
   - 对比分析时隐藏竞品酒店敏感信息

### File List

**后端新增/修改文件：**
- apps/api/src/main/java/com/hotel/service/ReviewAnalyticsService.java (扩展)
- apps/api/src/main/java/com/hotel/service/TextAnalysisService.java (新增)
- apps/api/src/main/java/com/hotel/controller/review/ReviewStatisticsController.java (新增)
- apps/api/src/main/java/com/hotel/dto/review/statistics/ReviewStatisticsDTO.java (新增)
- apps/api/src/main/java/com/hotel/dto/review/statistics/RatingTrendDTO.java (新增)
- apps/api/src/main/java/com/hotel/dto/review/statistics/WordCloudDTO.java (新增)
- apps/api/src/main/java/com/hotel/dto/review/statistics/HotelComparisonDTO.java (新增)
- apps/api/src/main/java/com/hotel/dto/review/statistics/SuggestionDTO.java (新增)
- apps/api/src/main/resources/db/migration/V1_0_5__Add_review_performance_indexes.sql (新增)

**前端新增/修改文件：**
- apps/web/src/pages/admin/reviews/ReviewStatistics.vue (新增)
- apps/web/src/components/business/review/statistics/StatisticsOverview.vue (新增)
- apps/web/src/components/business/review/statistics/RatingTrendChart.vue (新增)
- apps/web/src/components/business/review/statistics/ReviewWordCloud.vue (新增)
- apps/web/src/components/business/review/statistics/ImprovementSuggestions.vue (新增)
- apps/web/src/components/business/review/statistics/HotelComparisonChart.vue (新增)
- apps/web/src/services/reviewService.ts (扩展)

## QA Results

[To be filled by QA Agent]