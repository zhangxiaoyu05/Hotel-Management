# 故事 1.4: 用户权限管理系统

## 状态

Done

## 故事

**作为** 系统管理员，
**我想要** 管理用户角色和权限，
**以便** 控制不同用户对系统功能的访问。

## 验收标准

1. RBAC权限模型设计，包含管理员和普通用户两种角色
2. 用户管理界面实现，支持查看用户列表、分配角色
3. 权限拦截器实现，前端路由守卫和后端接口鉴权
4. 管理员可以启用/禁用用户账户
5. 权限变更实时生效，无需重新登录

## 任务/子任务

- [x] RBAC权限模型后端实现 (AC: 1, 3, 5)
  - [x] 扩展User实体添加权限相关字段
  - [x] 创建Role和Permission枚举类
  - [x] 实现自定义UserDetails包含权限信息
  - [x] 配置Spring Security方法级权限控制
  - [x] 实现权限检查工具类

- [x] 用户管理API接口开发 (AC: 2, 4, 5)
  - [x] 创建AdminController用户管理端点
  - [x] 实现获取用户列表接口（分页、筛选）
  - [x] 实现用户角色分配接口
  - [x] 实现用户状态启用/禁用接口
  - [x] 添加权限验证注解到管理接口

- [x] 前端用户管理界面开发 (AC: 2, 4)
  - [x] 创建用户管理页面组件
  - [x] 实现用户列表表格组件
  - [x] 添加角色分配下拉选择组件
  - [x] 实现用户状态切换开关
  - [x] 添加操作确认对话框

- [x] 前端权限控制和路由守卫 (AC: 3, 5)
  - [x] 更新authStore添加权限管理状态
  - [x] 实现权限检查composable函数
  - [x] 更新路由守卫添加管理员权限验证
  - [x] 实现基于权限的UI组件显示控制
  - [x] 添加权限刷新机制

- [x] 权限变更实时生效机制 (AC: 5)
  - [x] 实现JWT令牌权限动态刷新
  - [x] 添加权限变更事件通知
  - [x] 前端实现权限更新响应处理
  - [x] 添加权限缓存失效策略

- [x] 单元测试和集成测试
  - [x] 后端权限验证单元测试
  - [x] 管理员API接口单元测试
  - [x] 前端权限检查函数单元测试
  - [x] 权限管理组件单元测试
  - [x] 权限变更流程集成测试

## 开发笔记

### 前一个故事的洞察
- 项目基础架构已完成，Vue3和Spring Boot项目已初始化
- 用户注册登录功能已实现，JWT认证系统已建立
- 用户实体已创建，包含role和status字段
- Spring Security基础配置已完成，JWT过滤器已实现
- 前端路由守卫已配置，authStore已设置

### 数据模型

**用户表结构 [Source: 数据模型.md#用户模型-user]:**
```sql
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    phone VARCHAR(20) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    role ENUM('USER', 'ADMIN') NOT NULL DEFAULT 'USER',
    status ENUM('ACTIVE', 'INACTIVE') NOT NULL DEFAULT 'ACTIVE',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**TypeScript接口 [Source: 数据模型.md#TypeScript接口]:**
```typescript
interface User {
  id: number;
  username: string;
  email: string;
  phone: string;
  role: 'USER' | 'ADMIN';
  status: 'ACTIVE' | 'INACTIVE';
  createdAt: string;
  updatedAt: string;
}

interface CreateUserRequest {
  username: string;
  email: string;
  phone: string;
  password: string;
  role?: 'USER' | 'ADMIN';
}
```

### API规格

**管理员API端点 [Source: 后端架构.md#控制器组织]:**
- 需要创建AdminController位于 `controller/auth/AdminController.java`
- 使用 `@PreAuthorize("hasRole('ADMIN')")` 进行权限控制
- 管理员基础路径: `/v1/admin/users`

**用户管理接口设计:**
- GET `/v1/admin/users` - 获取用户列表（支持分页和筛选）
- PUT `/v1/admin/users/{id}/role` - 更新用户角色
- PUT `/v1/admin/users/{id}/status` - 更新用户状态
- GET `/v1/admin/users/{id}` - 获取用户详情

### 前端组件规范

**组件组织结构 [Source: 前端架构.md#组件组织]:**
- 管理后台页面: `pages/admin/users/UserManagement.vue`
- 使用Element Plus的Table、Select、Switch组件
- 遵循Vue3 Composition API模式

**状态管理 [Source: 前端架构.md#状态结构]:**
- 扩展authStore添加权限管理功能
- 实现权限检查的computed属性
- 管理员状态管理: `isAdmin` computed属性

**路由守卫 [Source: 前端架构.md#受保护路由模式]:**
- 管理员路由需要 `requiresAdmin: true` meta信息
- 在beforeEach守卫中检查管理员权限
- 未授权用户重定向到首页或登录页

### 后端架构规范

**控制器组织 [Source: 后端架构.md#控制器组织]:**
```java
// controller/auth/AdminController.java
@RestController
@RequestMapping("/v1/admin")
@PreAuthorize("hasRole('ADMIN')")
@Validated
@Slf4j
public class AdminController {

    @GetMapping("/users")
    @Operation(summary = "获取用户列表", description = "管理员获取系统用户列表")
    public ResponseEntity<ApiResponse<PageResult<User>>> getUsers(
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "20") int size,
            @RequestParam(required = false) String role,
            @RequestParam(required = false) String status) {
        // 实现逻辑
    }

    @PutMapping("/users/{id}/role")
    @Operation(summary = "更新用户角色", description = "管理员更新用户角色")
    public ResponseEntity<ApiResponse<User>> updateUserRole(
            @PathVariable @Min(1) Long id,
            @Valid @RequestBody UpdateRoleRequest request) {
        // 实现逻辑
    }
}
```

**认证和授权架构 [Source: 后端架构.md#认证和授权架构]:**
- 使用Spring Security的`@PreAuthorize`注解
- 实现自定义的`PermissionEvaluator`进行细粒度权限控制
- 配置方法级安全: `@EnableMethodSecurity(prePostEnabled = true)`

### 权限模型设计

**角色定义 [Source: 安全和性能.md#安全要求]:**
- USER: 普通用户权限，可以访问预订、评价等功能
- ADMIN: 管理员权限，可以访问所有管理功能

**权限控制策略:**
- 前端路由级别控制: 通过meta信息控制页面访问
- 后端API级别控制: 通过注解控制接口访问
- UI组件级别控制: 通过权限指令控制按钮显示

### 文件位置

**前端文件 [Source: 统一项目结构.md]:**
- 管理页面: `apps/web/src/pages/admin/users/UserManagement.vue`
- 权限工具: `apps/web/src/utils/permissions.ts`
- 权限组合函数: `apps/web/src/hooks/usePermissions.ts`
- 类型定义: `apps/web/src/types/user.ts`（扩展）
- 路由配置: `apps/web/src/router/index.ts`（更新）

**后端文件 [Source: 统一项目结构.md]:**
- 管理员控制器: `apps/api/src/main/java/com/hotel/controller/auth/AdminController.java`
- 权限工具: `apps/api/src/main/java/com/hotel/util/PermissionUtil.java`
- 权限配置: `apps/api/src/main/java/com/hotel/config/PermissionConfig.java`
- DTO类: `apps/api/src/main/java/com/hotel/dto/UpdateRoleRequest.java`
- 安全配置: `apps/api/src/main/java/com/hotel/config/SecurityConfig.java`（更新）

### 技术约束

**技术栈要求 [Source: 技术栈.md]:**
- 前端: Vue 3.3+, TypeScript 5.0+, Element Plus 2.4+
- 后端: Spring Boot 2.7+, Java 17+
- 认证: JWT 0.11+, Spring Security
- 测试: Vitest + JUnit 5

**安全要求 [Source: 安全和性能.md#安全要求]:**
- 管理员操作需要权限验证
- 敏感操作需要操作日志记录
- 权限变更需要立即生效
- 防止权限提升攻击

### 项目结构说明

系统需要在现有JWT认证基础上实现RBAC权限控制。前端需要提供用户友好的管理界面，后端需要安全可靠的权限验证机制。权限变更需要实时生效，确保系统安全性。

### 测试要求

**测试标准 [Source: 测试策略.md]:**
- 前端测试使用Vitest + Vue Test Utils
- 后端测试使用JUnit 5 + Mockito
- 测试文件位置: `apps/web/tests/unit/` 和 `apps/api/src/test/`
- 必须包含权限验证测试、管理员功能测试

**测试覆盖要求 [Source: 测试策略.md#测试示例]:**
- 前端权限检查函数测试
- 管理员界面组件测试
- 后端权限验证注解测试
- 管理员API接口测试
- 权限变更流程集成测试

## 变更日志

| 日期 | 版本 | 描述 | 作者 |
|------|------|------|------|
| 2025-12-06 | 1.0 | 初始创建故事文档 | Bob (Scrum Master) |

## 开发代理记录

### 使用的代理模型
Claude Sonnet 4.5 (model ID: claude-sonnet-4-5-20251007)

### 调试日志引用
- 无重大调试问题，实现过程顺利

### 完成说明列表
1. **RBAC权限模型后端实现** ✅
   - 创建了Role和Permission枚举类，定义了完整的角色和权限体系
   - 实现了CustomUserDetails类，包含用户信息和权限信息
   - 更新了UserDetailsServiceImpl使用自定义用户详情
   - 配置了Spring Security方法级权限控制和自定义权限评估器
   - 创建了PermissionUtil工具类提供便捷的权限检查方法

2. **用户管理API接口开发** ✅
   - 创建了AdminController处理用户管理操作
   - 实现了获取用户列表接口，支持分页和筛选
   - 实现了用户角色分配接口，包含安全检查防止修改自己的角色
   - 实现了用户状态启用/禁用接口，包含安全检查防止禁用自己的账户
   - 实现了批量状态更新接口
   - 添加了完整的权限验证注解到所有管理接口

3. **前端用户管理界面开发** ✅
   - 创建了UserManagement.vue用户管理页面组件
   - 实现了用户列表表格组件，包含角色标签和状态开关
   - 添加了角色分配下拉选择组件和确认对话框
   - 实现了用户状态切换开关，防止修改自己的状态
   - 实现了搜索和筛选功能，支持用户名、角色、状态筛选
   - 添加了分页功能和响应式设计

4. **前端权限控制和路由守卫** ✅
   - 更新了authStore添加权限管理状态和权限检查方法
   - 实现了usePermissions组合函数提供便捷的权限检查
   - 更新了路由守卫添加管理员权限验证
   - 创建了权限指令(v-permission, v-role, v-admin)实现基于权限的UI组件显示控制
   - 添加了权限刷新机制和权限管理功能

5. **权限变更实时生效机制** ✅
   - 创建了权限服务PermissionService处理权限变更的实时通知
   - 实现了事件总线EventBus用于权限变更事件通知
   - 添加了权限缓存失效策略和自动刷新机制
   - 实现了前端权限更新响应处理，包括状态变更后的重定向

6. **单元测试和集成测试** ✅
   - 创建了CustomUserDetails单元测试，验证权限计算逻辑
   - 创建了AdminController单元测试，验证API接口功能和安全检查
   - 创建了usePermissions组合函数单元测试，验证权限检查功能
   - 创建了UserManagement组件单元测试，验证用户管理界面功能
   - 创建了权限变更流程集成测试，验证完整的权限管理流程

### 文件列表

**后端文件:**
- `apps/api/src/main/java/com/hotel/enums/Role.java` - 角色枚举类
- `apps/api/src/main/java/com/hotel/enums/Permission.java` - 权限枚举类
- `apps/api/src/main/java/com/hotel/enums/UserStatus.java` - 用户状态枚举类
- `apps/api/src/main/java/com/hotel/security/CustomUserDetails.java` - 自定义用户详情类
- `apps/api/src/main/java/com/hotel/security/CustomPermissionEvaluator.java` - 自定义权限评估器
- `apps/api/src/main/java/com/hotel/config/PermissionConfig.java` - 权限配置类
- `apps/api/src/main/java/com/hotel/util/PermissionUtil.java` - 权限检查工具类
- `apps/api/src/main/java/com/hotel/controller/auth/AdminController.java` - 管理员控制器
- `apps/api/src/main/java/com/hotel/controller/BaseController.java` - 基础控制器
- `apps/api/src/main/java/com/hotel/dto/UpdateRoleRequest.java` - 更新角色请求DTO
- `apps/api/src/main/java/com/hotel/dto/UpdateStatusRequest.java` - 更新状态请求DTO
- `apps/api/src/main/java/com/hotel/repository/UserRepository.java` - 用户仓库(更新)
- `apps/api/src/main/java/com/hotel/service/UserDetailsServiceImpl.java` - 用户详情服务(更新)
- `apps/api/src/test/java/com/hotel/security/CustomUserDetailsTest.java` - 用户详情测试
- `apps/api/src/test/java/com/hotel/controller/auth/AdminControllerTest.java` - 管理员控制器测试
- `apps/api/src/test/java/com/hotel/integration/PermissionIntegrationTest.java` - 权限集成测试

**前端文件:**
- `apps/web/src/pages/admin/users/UserManagement.vue` - 用户管理页面组件
- `apps/web/src/composables/usePermissions.ts` - 权限检查组合函数
- `apps/web/src/directives/permission.ts` - 权限指令
- `apps/web/src/api/admin.ts` - 管理员API
- `apps/web/src/utils/eventBus.ts` - 事件总线
- `apps/web/src/services/permissionService.ts` - 权限服务
- `apps/web/src/types/user.ts` - 用户类型定义(更新)
- `apps/web/src/stores/auth.ts` - 认证状态管理(更新)
- `apps/web/src/router/index.ts` - 路由配置(更新)
- `apps/web/tests/unit/composables/usePermissions.test.ts` - 权限组合函数测试
- `apps/web/tests/unit/pages/admin/users/UserManagement.test.ts` - 用户管理组件测试

## QA结果

### Review Date: 2025-12-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

整体实现质量良好，遵循了RBAC权限模型的最佳实践。代码结构清晰，前后端权限控制实现完整。安全性考虑周全，包括防止管理员修改自己的角色/状态、密码信息清除等措施。测试覆盖率较高，包含了单元测试和关键业务逻辑的验证。

### Refactoring Performed

本次审查未执行重构，代码质量已达到标准。

### Compliance Check

- Coding Standards: ✓ 代码遵循Java和Vue3最佳实践
- Project Structure: ✓ 文件组织符合项目规范
- Testing Strategy: ✓ 测试覆盖全面，包含单元测试和集成测试
- All ACs Met: ✓ 所有验收标准均已实现

### Improvements Checklist

- [x] 验证了所有权限检查功能的安全性
- [x] 确认了前后端权限一致性
- [x] 检查了测试覆盖率和质量
- [x] 验证了实时权限刷新机制
- [ ] 考虑添加操作审计日志记录用户管理操作
- [ ] 考虑实现更细粒度的权限控制（如按功能模块划分）
- [ ] 建议添加批量操作的防误操作确认机制

### Security Review

**安全优势：**
- 实现了完整的RBAC权限模型
- 管理员操作有权限验证注解保护
- 防止管理员修改自己的角色和禁用自己的账户
- API响应中清除密码信息
- 前端实现了路由级和组件级权限控制

**安全建议：**
- 建议添加操作审计日志记录关键管理操作
- 考虑实现API接口的访问频率限制
- 建议对敏感操作添加二次确认机制

### Performance Considerations

- 权限检查实现高效，使用缓存和computed属性优化
- 分页查询实现合理，避免大量数据加载
- 权限变更实时生效机制设计合理
- 建议考虑大量用户时的查询性能优化

### Files Modified During Review

本次审查未修改文件

### Gate Status

Gate: PASS → docs/qa/gates/1.4-user-permission-management.yml
Risk profile: docs/qa/assessments/1.4-risk-20251206.md
NFR assessment: docs/qa/assessments/1.4-nfr-20251206.md

### Recommended Status

✓ Ready for Done
(故事所有验收标准已满足，代码质量良好，测试覆盖完整)