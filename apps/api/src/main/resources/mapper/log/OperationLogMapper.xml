<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hotel.repository.log.OperationLogRepository">

    <!-- 操作日志结果映射 -->
    <resultMap id="OperationLogResultMap" type="com.hotel.entity.log.OperationLog">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="username" property="username"/>
        <result column="operation" property="operation"/>
        <result column="method" property="method"/>
        <result column="params" property="params"/>
        <result column="time" property="time"/>
        <result column="ip" property="ip"/>
        <result column="user_agent" property="userAgent"/>
        <result column="status" property="status"/>
        <result column="error_message" property="errorMessage"/>
        <result column="create_time" property="createTime"/>
    </resultMap>

    <!-- 分页查询操作日志 -->
    <select id="searchLogs" resultMap="OperationLogResultMap">
        SELECT
            id, user_id, username, operation, method, params, time, ip, user_agent, status, error_message, create_time
        FROM operation_logs
        <where>
            <if test="username != null and username != ''">
                AND username LIKE CONCAT('%', #{username}, '%')
            </if>
            <if test="operation != null and operation != ''">
                AND operation LIKE CONCAT('%', #{operation}, '%')
            </if>
            <if test="startTime != null">
                AND create_time >= #{startTime}
            </if>
            <if test="endTime != null">
                AND create_time &lt;= #{endTime}
            </if>
            <if test="ip != null and ip != ''">
                AND ip LIKE CONCAT('%', #{ip}, '%')
            </if>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
        </where>
        <choose>
            <when test="sortField != null and sortField != '' and sortDirection != null and sortDirection != ''">
                ORDER BY ${sortField} ${sortDirection}
            </when>
            <otherwise>
                ORDER BY create_time DESC
            </otherwise>
        </choose>
    </select>

    <!-- 根据用户ID查询操作日志 -->
    <select id="findByUserId" resultMap="OperationLogResultMap">
        SELECT
            id, user_id, username, operation, method, params, time, ip, user_agent, status, error_message, create_time
        FROM operation_logs
        WHERE user_id = #{userId}
        ORDER BY create_time DESC
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 根据时间范围删除操作日志 -->
    <delete id="deleteByTimeRange">
        DELETE FROM operation_logs
        WHERE create_time &lt; #{endTime}
    </delete>

    <!-- 统计操作日志数量 -->
    <select id="countByTimeRange" resultType="long">
        SELECT COUNT(*)
        FROM operation_logs
        <where>
            <if test="startTime != null">
                AND create_time >= #{startTime}
            </if>
            <if test="endTime != null">
                AND create_time &lt;= #{endTime}
            </if>
        </where>
    </select>

</mapper>